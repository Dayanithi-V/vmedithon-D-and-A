<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Image Data Exchange</title>
    <style>
        body {
            background-color: #121212; /* Dark background */
            color: #e0e0e0; /* Light text color */
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            text-align: center;
        }
        header {
            background: linear-gradient(90deg, #3f51b5, #1e88e5); /* Gradient header */
            padding: 20px;
            font-size: 36px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.7);
        }
        .menu {
            margin: 30px 0;
        }
        .menu button {
            background-color: #3f51b5; /* Indigo button color */
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 20px;
            margin: 0 15px; /* Space between buttons */
            transition: background 0.3s, transform 0.2s; /* Smooth transition */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }
        .menu button:hover {
            background-color: #5c6bc0; /* Button hover color */
            transform: scale(1.05); /* Slightly enlarge on hover */
        }
        .container {
            background: #1e1e1e; /* Dark gray container background */
            padding: 40px;
            max-width: 600px; /* Set maximum width for better alignment */
            margin: 20px auto; /* Center align */
            border-radius: 15px;
            border: 2px solid #3f51b5; /* Blue border */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.7);
            text-align: left;
            display: none; /* Hide sections initially */
        }
        h3 {
            margin-bottom: 20px; /* Space below headings */
            color: #ffffff; /* Heading color */
            text-align: center; /* Center heading */
            border-bottom: 2px solid #3f51b5; /* Bottom border for headings */
            padding-bottom: 10px; /* Space below the heading */
        }
        label {
            font-weight: bold; /* Bold labels */
            margin-bottom: 5px; /* Space below labels */
            display: block; /* Block display for labels */
            color: #b0bec5; /* Lighter label color */
        }
        input[type="file"], select {
            display: block;
            width: 100%;
            margin: 10px 0;
            font-size: 16px;
            padding: 12px; /* Increased padding for inputs */
            background-color: #424242; /* Input background color */
            color: #ffffff; /* Input text color */
            border: 2px solid #3f51b5; /* Input border */
            border-radius: 8px;
            transition: border-color 0.3s; /* Transition for border color */
        }
        input[type="file"]:hover, select:hover {
            border-color: #5c6bc0; /* Border color on hover */
        }
        button[type="submit"] {
            background-color: #3f51b5; /* Button background color */
            color: white;
            padding: 15px 25px;
            border: none; /* Remove border */
            border-radius: 25px;
            cursor: pointer;
            font-size: 20px;
            margin: 10px 0;
            transition: background 0.3s, transform 0.2s; /* Transition for hover effect */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }
        button[type="submit"]:hover {
            background-color: #5c6bc0; /* Button hover color */
            transform: scale(1.05); /* Slightly enlarge on hover */
        }
        #status, #decryptStatus {
            margin-top: 20px;
            color: #4caf50; /* Success color */
        }
        #error {
            color: #e57373; /* Error color */
        }
    </style>
</head>
<body>
    <header>
        Secure Image Data Exchange
    </header>
    
    <div class="menu">
        <button onclick="showSection('secure-transmission')">Secure Transmission</button>
        <button onclick="showSection('retrieve-file')">Retrieve File</button>
    </div>

    <div class="container" id="secure-transmission">
        <h3>Secure Transmission</h3>
        <form id="fileTransferForm">
            <label for="fileUpload">Upload Image File:</label>
            <input type="file" id="fileUpload" accept=".jpg,.jpeg,.png,.gif" required />

            <label for="departments">Select Department:</label>
            <select id="departments" required>
                <option value="">Choose a department...</option>
                <option value="Cardiology">Cardiology</option>
                <option value="Neurology">Neurology</option>
                <option value="Pediatrics">Pediatrics</option>
                <option value="Oncology">Oncology</option>
                <option value="Radiology">Radiology</option>
                <option value="Orthopedics">Orthopedics</option>
                <option value="Emergency">Emergency</option>
                <option value="Surgery">Surgery</option>
                <option value="Dermatology">Dermatology</option>
                <option value="Gastroenterology">Gastroenterology</option>
                <option value="Endocrinology">Endocrinology</option>
                <option value="Pulmonology">Pulmonology</option>
                <option value="Urology">Urology</option>
                <option value="Nephrology">Nephrology</option>
                <option value="Psychiatry">Psychiatry</option>
                <option value="Gynecology">Gynecology</option>
                <option value="Ophthalmology">Ophthalmology</option>
                <option value="Pathology">Pathology</option>
                <option value="Anesthesiology">Anesthesiology</option>
            </select>

            <button type="submit">Encrypt and Download</button>
        </form>
        <div id="status"></div>
        <div id="error"></div>
    </div>

    <div class="container" id="retrieve-file">
        <h3>Retrieve File</h3>
        <form id="decryptForm">
            <label for="encryptedFileUpload">Upload Encrypted Image File:</label>
            <input type="file" id="encryptedFileUpload" accept=".enc" required />
            <button type="submit">Decrypt and Download</button>
        </form>
        <div id="decryptStatus"></div>
    </div>

    <script>
        // Show the selected section
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.container').forEach(section => {
                section.style.display = 'none';
            });

            // Show the selected section
            document.getElementById(sectionId).style.display = 'block';
        }

        // Utility to convert ArrayBuffer to base64
        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let byte of bytes) {
                binary += String.fromCharCode(byte);
            }
            return window.btoa(binary);
        }

        // Utility to download files
        function downloadFile(filename, content) {
            const blob = new Blob([content], { type: "application/octet-stream" });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // File encryption using AES-GCM
        async function encryptFile(file) {
            const key = await crypto.subtle.generateKey(
                { name: "AES-GCM", length: 256 },
                true,
                ["encrypt", "decrypt"]
            );

            const iv = crypto.getRandomValues(new Uint8Array(12)); // AES-GCM requires 12-byte IV
            const fileData = await file.arrayBuffer();
            const encryptedData = await crypto.subtle.encrypt(
                { name: "AES-GCM", iv: iv },
                key,
                fileData
            );

            const exportedKey = await crypto.subtle.exportKey("raw", key);

            return {
                encryptedData: new Uint8Array(encryptedData),
                iv: iv,
                key: new Uint8Array(exportedKey)
            };
        }

        document.getElementById('fileTransferForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const file = document.getElementById('fileUpload').files[0];
            if (!file) {
                alert("Please upload a file to encrypt.");
                return;
            }

            try {
                const { encryptedData, iv, key } = await encryptFile(file);
                const fullData = new Uint8Array(iv.length + encryptedData.length + key.length);
                fullData.set(iv, 0);
                fullData.set(encryptedData, iv.length);
                fullData.set(key, iv.length + encryptedData.length);
                downloadFile("encrypted_image.enc", fullData); // Download as encrypted file
                document.getElementById('status').innerText = "File encrypted and downloaded successfully!";
                document.getElementById('error').innerText = ""; // Clear any previous errors
            } catch (error) {
                document.getElementById('status').innerText = "";
                document.getElementById('error').innerText = "Error encrypting file.";
            }
        });

        // File decryption using AES-GCM
        async function decryptFile(file) {
            const fileData = await file.arrayBuffer();
            const encryptedData = new Uint8Array(fileData);

            const iv = encryptedData.slice(0, 12); // First 12 bytes are the IV
            const key = encryptedData.slice(encryptedData.length - 32); // Last 32 bytes are the key
            const data = encryptedData.slice(12, encryptedData.length - 32); // Encrypted data

            const cryptoKey = await crypto.subtle.importKey(
                "raw",
                key,
                { name: "AES-GCM" },
                false,
                ["decrypt"]
            );

            return await crypto.subtle.decrypt(
                { name: "AES-GCM", iv: iv },
                cryptoKey,
                data
            );
        }

        document.getElementById('decryptForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const encryptedFile = document.getElementById('encryptedFileUpload').files[0];
            if (!encryptedFile) {
                alert("Please upload an encrypted file to decrypt.");
                return;
            }

            try {
                const decryptedData = await decryptFile(encryptedFile);
                downloadFile("decrypted_image.png", decryptedData); // Download as PNG
                document.getElementById('decryptStatus').innerText = "File decrypted and downloaded successfully!";
            } catch (error) {
                document.getElementById('decryptStatus').innerText = "Error decrypting file.";
            }
        });
    </script>
</body>
</html>
